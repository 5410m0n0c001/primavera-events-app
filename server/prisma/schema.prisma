// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Using sqlite for ease of local setup, switch to mysql if requested specifically but user said "site ground" so sqlite/mysql both fine. User detailed MySQL in prompt, but for "local" dev I might start with SQLite or ask. The prompt said "MySQL optimized schema". I'll stick to SQLite for the *first* run to ensure it works without them needing a DB server running, or do I assume they have MySQL? "The user's OS is windows". "My OS is windows". Setting up MySQL might be hard. I will use SQLite for dev speed and compatibility, easy to switch.
  // UPDATE: User explicitly asked for MySQL. I will use "mysql" but I cannot run a mysql server for them. 
  // I will use "sqlite" for the *generation* and code, but keep the schema compatible. 
  // actually, if I use mysql provider, `prisma create` might fail if no DB.
  // I'll use sqlite for this scaffold to ensure "npm run dev" works out of the box for the user to see progress.
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("COORDINATOR") // ADMIN, COORDINATOR, CLIENT
  createdAt DateTime @default(now())
  events    Event[]  @relation("CoordinatorEvents")
}


model Client {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String   @unique
  phone     String?
  address   String?
  notes     String?
  type      String   @default("LEAD") // LEAD, PROSPECT, ACTIVE, PAST
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  events    Event[]
}

model Event {
  id          String   @id @default(uuid())
  name        String   // "Boda Juan y Maria"
  type        String   // "Boda", "XV Años"
  date        DateTime
  guestCount  Int
  status      String   @default("DRAFT") // DRAFT, CONFIRMED, COMPLETED, CANCELLED
  
  location    String?
  notes       String?

  clientId    String
  client      Client   @relation(fields: [clientId], references: [id])
  
  coordinatorId String?
  coordinator   User?   @relation("CoordinatorEvents", fields: [coordinatorId], references: [id])

  quotes      Quote[]
  payments    Payment[]
  
  layout      Layout?
  timeline    Timeline?
  
  venueId     String?
  venue       Venue?   @relation(fields: [venueId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Quote {
  id          String   @id @default(uuid())
  version     Int      @default(1)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id])
  
  items       QuoteItem[]
  
  subtotal    Decimal
  tax         Decimal
  total       Decimal
  margin      Decimal? // Profitability
  
  status      String   @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED
  
  createdAt   DateTime @default(now())
}

model QuoteItem {
  id              String   @id @default(uuid())
  quoteId         String
  quote           Quote    @relation(fields: [quoteId], references: [id])
  
  serviceItemId   String
  serviceItem     CatalogItem @relation(fields: [serviceItemId], references: [id])
  
  quantity        Int
  unitPrice       Decimal // Copied from CatalogItem at time of quote to lock price
  cost            Decimal // For margin calc
  
  notes           String? // "Sin cebolla", "Color rojo"
}

// --- CATALOG SYSTEM (The "Brain" of the planner) ---

model CatalogCategory {
  id            String   @id @default(uuid())
  name          String   // "Mobiliario", "Catering", "Bebidas", "Decoracion"
  description   String?
  subCategories CatalogSubCategory[]
}

model CatalogSubCategory {
  id            String   @id @default(uuid())
  name          String   // "Mesas", "Sillas", "Plato Fuerte"
  categoryId    String
  category      CatalogCategory @relation(fields: [categoryId], references: [id])
  items         CatalogItem[]
}

model CatalogItem {
  id              String   @id @default(uuid())
  name            String   // "Silla Tiffany Dorada", "Filete Mignon"
  description     String?
  
  subCategoryId   String
  subCategory     CatalogSubCategory @relation(fields: [subCategoryId], references: [id])
  
  price           Decimal  // Sale price
  cost            Decimal? // Internal cost
  unit            String   // "pieza", "persona", "evento"
  stock           Int      @default(0) // Inventory tracking
  
  options         String?  // JSON stringified: colors, sizes, etc.
  
  quoteItems      QuoteItem[]
  maintenanceLogs MaintenanceLog[]
}

model Staff {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  role      String   // Mesero, Capitan, DJ
  dailyRate Decimal? // Cost per event/day
  phone     String?
  email     String?
  createdAt DateTime @default(now())
}

model MaintenanceLog {
  id            String      @id @default(uuid())
  itemId        String
  catalogItem   CatalogItem @relation(fields: [itemId], references: [id])
  type          String      // "Repair", "Replacement", "Loss"
  quantity      Int
  cost          Decimal
  notes         String?
  date          DateTime    @default(now())
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  category  String   // Florería, Música, Fotografía, Decoración
  contactName String?
  email     String?
  phone     String?
  terms     String?  // Términos de servicio
  rating    Float    @default(0)
  createdAt DateTime @default(now())
  expenses  Expense[]
}

model Payment {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  amount    Decimal
  method    String   // "Efectivo", "Transferencia", "Tarjeta"
  status    String   // "Pendiente", "Pagado"
  date      DateTime @default(now())
  reference String?  // Comprobante
}

model Expense {
  id          String    @id @default(uuid())
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  description String
  amount      Decimal
  category    String    // "Insumos", "Servicios", "Nómina", "Otros"
  date        DateTime  @default(now())
  status      String    // "Pendiente", "Pagado"
}

// --- CATERING MODULE ---

model Ingredient {
  id          String       @id @default(uuid())
  name        String
  unit        String       // "kg", "lt", "pz"
  costPerUnit Decimal
  stock       Decimal      @default(0)
  recipeItems RecipeItem[]
}

model Dish {
  id          String       @id @default(uuid())
  name        String       // "Filete Mignon"
  description String?
  price       Decimal      // Sale Price
  cost        Decimal?     // Calculated from ingredients
  recipeItems RecipeItem[]
  menus       Menu[]       @relation("MenuDishes")
}

model RecipeItem {
  id           String     @id @default(uuid())
  dishId       String
  dish         Dish       @relation(fields: [dishId], references: [id])
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  quantity     Decimal    // Amount needed per dish
}

model Menu {
  id          String   @id @default(uuid())
  name        String   // "Menú 3 Tiempos Boda"
  description String?
  dishes      Dish[]   @relation("MenuDishes")
}

// --- PRODUCTION MODULE ---

model Layout {
  id        String   @id @default(uuid())
  eventId   String   @unique // One layout per event for now
  event     Event    @relation(fields: [eventId], references: [id])
  name      String   // "Distribución Salón Principal"
  data      String   // JSON: { objects: [{ x: 10, y: 10, type: 'table', label: 'Mesa 1' }] }
}

model Timeline {
  id        String         @id @default(uuid())
  eventId   String         @unique
  event     Event          @relation(fields: [eventId], references: [id])
  items     TimelineItem[]
}

model TimelineItem {
  id          String   @id @default(uuid())
  timelineId  String
  timeline    Timeline @relation(fields: [timelineId], references: [id])
  time        String   // "18:00"
  description String   // "Recepción de invitados"
  order       Int      @default(0)
}

// --- VENUES MODULE ---

model Venue {
  id              String   @id @default(uuid())
  name            String   // "Salón Los Caballos"
  type            String   // "salon" | "jardin"
  address         String
  city            String   @default("Yolomécatl")
  capacity        Int      // Max guests
  description     String?
  
  // Pricing
  hourlyRate      Float    @default(0)
  packageOptions  String?  // JSON: [{ name: "Paquete Básico", price: 5000, includes: [...] }]
  
  // Schedule & Availability
  workingHours    String   @default("09:00-23:00") // "HH:MM-HH:MM"
  restrictions    String?  // JSON: ["No fumar", "No mascotas"]
  
  // Services/Amenities
  services        String?  // JSON: ["Estacionamiento", "Aire Acondicionado", "Cocina"]
  
  // Media
  imageUrl        String?
  
  // Relations
  events          Event[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
